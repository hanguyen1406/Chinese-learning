<div class="pl-2 pr-2">
  <!-- Form đăng comment mới -->
  <div class="d-flex">
    <img
      src="assets/pr.jpg"
      alt="avatar"
      width="50"
      height="50"
      class="avatar-img"
    />
    <input
      [(ngModel)]="commentText"
      (keyup.enter)="postComment()"
      id="comment-input"
      autocomplete="off"
      class="flex-fill"
      placeholder="Viết bình luận..."
    />
  </div>
  <div class="d-flex justify-content-end mt-1">
    <button
      class="btn"
      mat-raised-button
      color="primary"
      (click)="postComment()"
    >
      Bình luận
    </button>
  </div>

  <!-- Danh sách comments -->
  <div
    #cmtList
    *ngIf="comments && comments.length > 0; else noComments"
    class="cmtList"
  >
    <div class="mt-3" *ngFor="let cmt of comments">
      <!-- Comment cha -->
      <div class="comment-item d-flex mb-2">
        <img
          src="assets/pr.jpg"
          alt="avatar"
          width="40"
          height="40"
          class="avatar-img"
        />
        <div class="ml-2 flex-fill">
          <div class="comment-content">
            <b>{{ cmt.username }}</b>
            <p class="mb-1">{{ cmt.contentCmt }}</p>
          </div>
          <div class="d-flex align-items-center comment-actions">
            <small class="text-muted">{{
              cmt.timeCmt | date : "dd/MM/yyyy HH:mm"
            }}</small>
            <span class="action-divider">•</span>
            <a class="reply-link" (click)="startReply(cmt)">Trả lời</a>
            <span
              *ngIf="cmt.replies && cmt.replies.length > 0"
              class="action-divider"
              >•</span
            >
            <a
              *ngIf="cmt.replies && cmt.replies.length > 0"
              class="toggle-replies-link"
              (click)="toggleReplies(cmt.id!)"
            >
              {{ isRepliesExpanded(cmt.id!) ? "Ẩn" : "Xem" }}
              {{ cmt.replies.length }} phản hồi
            </a>
          </div>

          <!-- Form reply (hiện khi đang reply comment này) -->
          <div *ngIf="replyingToCommentId === cmt.id" class="reply-form mt-2">
            <div class="d-flex align-items-start">
              <img
                src="assets/pr.jpg"
                alt="avatar"
                width="32"
                height="32"
                class="avatar-img-small"
              />
              <div class="flex-fill ml-2">
                <input
                  [(ngModel)]="replyText"
                  (keyup.enter)="postReply(cmt)"
                  class="reply-input"
                  autocomplete="off"
                  [placeholder]="'Trả lời ' + replyingToUsername + '...'"
                />
                <div class="d-flex justify-content-end mt-1 reply-buttons">
                  <button class="btn-cancel" (click)="cancelReply()">
                    Hủy
                  </button>
                  <button class="btn-reply" (click)="postReply(cmt)">
                    Gửi
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Danh sách replies -->
          <div
            *ngIf="
              cmt.replies &&
              cmt.replies.length > 0 &&
              isRepliesExpanded(cmt.id!)
            "
            class="replies-container mt-2"
          >
            <div
              class="reply-item d-flex mb-2"
              *ngFor="let reply of cmt.replies"
            >
              <img
                src="assets/pr.jpg"
                alt="avatar"
                width="32"
                height="32"
                class="avatar-img-small"
              />
              <div class="ml-2 flex-fill">
                <div class="reply-content">
                  <b>{{ reply.username }}</b>
                  <p class="mb-1">{{ reply.contentCmt }}</p>
                </div>
                <div class="d-flex align-items-center comment-actions">
                  <small class="text-muted">{{
                    reply.timeCmt | date : "dd/MM/yyyy HH:mm"
                  }}</small>
                  <span class="action-divider">•</span>
                  <a class="reply-link" (click)="startReplyToReply(cmt, reply)"
                    >Trả lời</a
                  >
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <ng-template #noComments>
    <div class="text-center mt-3">
      <h3>
        Chưa có bình luận nào.<br />
        Hãy là người đầu tiên bình luận!
      </h3>
    </div>
  </ng-template>
</div>
