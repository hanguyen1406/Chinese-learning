<div style="margin-top: 80px" class="col-md-12">
  <div class="card card-container">
    <img
      id="profile-img"
      src="//ssl.gstatic.com/accounts/ui/avatar_2x.png"
      class="profile-img-card"
    />

    <!-- STEP 1: Form đăng ký -->
    <form *ngIf="step === 'form'" [formGroup]="formRegistrationUser" novalidate>
      <div class="form-group">
        <mat-form-field appearance="outline" class="example-full-width">
          <mat-label>Username</mat-label>
          <input
            matInput
            name="username"
            formControlName="username"
            class="example-full-width"
            required
          />
          <mat-error
            *ngIf="
              formRegistrationUser.controls['username'].hasError('required')
            "
          >
            Username là bắt buộc
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="example-full-width">
          <mat-label>Email</mat-label>
          <input
            matInput
            placeholder="pat@example.com"
            formControlName="email"
            required
            pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,3}$"
          />
          <mat-error
            *ngIf="formRegistrationUser.controls['email'].hasError('email')"
          >
            Email không hợp lệ
          </mat-error>
          <mat-error
            *ngIf="formRegistrationUser.controls['email'].hasError('required')"
          >
            Email là bắt buộc
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="example-full-width">
          <mat-label>Password</mat-label>
          <input
            matInput
            formControlName="password"
            [type]="hidePassword ? 'password' : 'text'"
            required
          />
          <button
            mat-icon-button
            matSuffix
            type="button"
            (click)="hidePassword = !hidePassword"
            [attr.aria-label]="'Hide password'"
            [attr.aria-pressed]="hidePassword"
          >
            <mat-icon>{{
              hidePassword ? "visibility_off" : "visibility"
            }}</mat-icon>
          </button>
          <mat-error
            *ngIf="
              formRegistrationUser.controls['password'].hasError('required')
            "
          >
            Password là bắt buộc
          </mat-error>
          <mat-error
            *ngIf="
              formRegistrationUser.controls['password'].hasError('minlength')
            "
          >
            Password phải có ít nhất 6 ký tự
          </mat-error>
        </mat-form-field>
      </div>

      <div class="form-group">
        <button
          type="button"
          class="btn btn-primary btn-block"
          [disabled]="!formRegistrationUser.valid"
          (click)="sendOtp()"
        >
          Tiếp tục
        </button>
        <button
          type="button"
          (click)="cancel()"
          mat-raised-button
          class="btn-block"
        >
          Thoát
        </button>
      </div>
    </form>

    <!-- STEP 2: Nhập OTP -->
    <div *ngIf="step === 'otp'" class="otp-container">
      <h4 class="text-center mb-3">Xác thực Email</h4>
      <p class="text-center text-muted mb-4">
        Mã OTP đã được gửi đến<br />
        <strong>{{ formRegistrationUser.get("email")?.value }}</strong>
      </p>

      <mat-form-field appearance="outline" class="example-full-width">
        <mat-label>Nhập mã OTP (6 số)</mat-label>
        <input
          matInput
          [(ngModel)]="otpCode"
          maxlength="6"
          placeholder="000000"
          class="text-center otp-input"
          style="letter-spacing: 8px; font-size: 24px; text-align: center"
        />
      </mat-form-field>

      <p class="text-center text-muted mb-3" style="font-size: 13px">
        Mã OTP có hiệu lực trong 5 phút
      </p>

      <div class="form-group">
        <button
          type="button"
          class="btn btn-primary btn-block"
          [disabled]="otpCode.length !== 6"
          (click)="verifyOtp()"
        >
          Xác nhận & Đăng ký
        </button>

        <button
          type="button"
          class="btn btn-outline-secondary btn-block mt-2"
          [disabled]="countdown > 0"
          (click)="resendOtp()"
        >
          {{
            countdown > 0 ? "Gửi lại OTP (" + countdown + "s)" : "Gửi lại OTP"
          }}
        </button>

        <button
          type="button"
          (click)="backToForm()"
          mat-raised-button
          class="btn-block mt-2"
        >
          Quay lại
        </button>
      </div>
    </div>

    <div style="text-align: center" class="mt-3">
      Đã có tài khoản?
      <a [routerLink]="['/login']">Đăng nhập ngay</a>
    </div>

    <div class="alert alert-warning mt-3" *ngIf="isSignUpFailed">
      Đăng ký thất bại!<br />{{ errorMessage }}
    </div>
  </div>
</div>
