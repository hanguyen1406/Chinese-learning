<h2 mat-dialog-title>Thêm câu hỏi</h2>

<mat-dialog-content class="question-dialog">
  <!-- Tabs -->
  <mat-tab-group [(selectedIndex)]="selectedTab">
    <!-- Tab 1: Manual Input -->
    <mat-tab label="Nhập thủ công">
      <div class="tab-content" [formGroup]="form">
        <!-- Nội dung câu hỏi -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Nội dung câu hỏi</mat-label>
          <textarea
            matInput
            rows="3"
            formControlName="content"
            placeholder="Nhập câu hỏi..."
          ></textarea>
          <mat-error *ngIf="form.get('content')?.hasError('required')">
            Bắt buộc nhập nội dung câu hỏi
          </mat-error>
        </mat-form-field>

        <!-- 4 đáp án -->
        <div class="answers-grid">
          <mat-form-field appearance="outline">
            <mat-label>Đáp án A</mat-label>
            <input matInput formControlName="a" />
            <mat-error>Nhập đáp án A</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Đáp án B</mat-label>
            <input matInput formControlName="b" />
            <mat-error>Nhập đáp án B</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Đáp án C</mat-label>
            <input matInput formControlName="c" />
            <mat-error>Nhập đáp án C</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Đáp án D</mat-label>
            <input matInput formControlName="d" />
            <mat-error>Nhập đáp án D</mat-error>
          </mat-form-field>
        </div>

        <!-- Đáp án đúng -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Đáp án đúng</mat-label>
          <mat-select formControlName="answer">
            <mat-option value="A">A</mat-option>
            <mat-option value="B">B</mat-option>
            <mat-option value="C">C</mat-option>
            <mat-option value="D">D</mat-option>
          </mat-select>
        </mat-form-field>

        <!-- Giải thích -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Giải thích (tùy chọn)</mat-label>
          <textarea
            matInput
            rows="2"
            formControlName="explanation"
            placeholder="Giải thích đáp án đúng..."
          ></textarea>
        </mat-form-field>

        <!-- Image URL -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Image URL (tùy chọn)</mat-label>
          <input
            matInput
            formControlName="imageUrl"
            placeholder="https://..."
          />
          <mat-error *ngIf="form.get('imageUrl')?.hasError('pattern')">
            URL phải bắt đầu bằng http:// hoặc https://
          </mat-error>
        </mat-form-field>
      </div>
    </mat-tab>

    <!-- Tab 2: Upload Word -->
    <mat-tab label="Upload Word">
      <div class="tab-content upload-section">
        <!-- Download Template -->
        <div class="template-section mt-1">
          <div>
            <p>Tải file Word mẫu để nhập câu hỏi nhanh hơn</p>
          </div>
          <button
            mat-stroked-button
            color="primary"
            (click)="downloadTemplate()"
          >
            <mat-icon>download</mat-icon>
            Tải file mẫu
          </button>
        </div>

        <!-- Upload Area -->
        <div
          class="upload-area"
          [class.drag-over]="isDragOver"
          (drop)="onDrop($event)"
          (dragover)="onDragOver($event)"
          (dragleave)="onDragLeave($event)"
          (click)="fileInput.click()"
        >
          <input
            #fileInput
            type="file"
            hidden
            accept=".docx"
            (change)="onFileSelected($event)"
          />

          <p class="upload-text">
            Kéo thả file Word vào đây hoặc click
            <mat-icon class="upload-icon m-1">cloud_upload</mat-icon> để chọn file
          </p>
          <p class="upload-hint">Hỗ trợ: .docx</p>
        </div>

        <!-- Selected File Info -->
        <div *ngIf="selectedFile" class="file-info">
          <mat-icon color="primary">insert_drive_file</mat-icon>
          <div class="file-details">
            <p class="file-name">{{ selectedFile.name }}</p>
            <p class="file-size">{{ formatFileSize(selectedFile.size) }}</p>
          </div>
          <button mat-icon-button (click)="removeFile()">
            <mat-icon>close</mat-icon>
          </button>
        </div>

        <!-- Preview Questions -->
        <div *ngIf="previewQuestions.length > 0" class="preview-section">
          <div class="preview-header">
            <h4>Preview {{ previewQuestions.length }} câu hỏi</h4>
            <button mat-button color="warn" (click)="clearPreview()">
              Xóa tất cả
            </button>
          </div>

          <div class="preview-list">
            <div
              *ngFor="let q of previewQuestions; let i = index"
              class="preview-item"
            >
              <span class="preview-number">{{ i + 1 }}</span>
              <div class="preview-content">
                <p class="preview-question">{{ q.content }}</p>
                <span class="preview-answer">Đáp án: {{ q.answer }}</span>
              </div>
              <button mat-icon-button (click)="removePreviewItem(i)">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
        </div>

        <!-- Word Format Info -->
        <div class="format-info">
          <mat-icon>info</mat-icon>
          <div>
            <p><strong>Định dạng file Word:</strong></p>
            <ul>
              <li>Nội dung câu hỏi:</li>
              <li>A. Nội dung đáp án A</li>
              <li>B. Nội dung đáp án B</li>
              <li>C. Nội dung đáp án C</li>
              <li>D. Nội dung đáp án D</li>
            </ul>
          </div>
        </div>
      </div>
    </mat-tab>
  </mat-tab-group>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button (click)="onCancel()">Hủy</button>
  <button
    mat-flat-button
    color="primary"
    (click)="onSave()"
    [disabled]="selectedTab === 0 ? !form.valid : previewQuestions.length === 0"
  >
    {{
      selectedTab === 0 ? "Lưu" : "Lưu " + previewQuestions.length + " câu hỏi"
    }}
  </button>
</mat-dialog-actions>
